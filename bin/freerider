#!/usr/bin/env ruby

require 'freerider'
require 'formatter'

SUMMARY_BORDER = '=========================='
RECORD_DELIMITER = SUMMARY_BORDER + SUMMARY_BORDER

key = ENV['CONSUMER_KEY']
location = ARGV[0].chomp if ARGV[0]
fuel_threshold = ARGV[1].chomp.to_i if ARGV[1]


unless key
  puts "You must supply a Car2Go consumer key (e.g., 'export CONSUMER_KEY=<your_key>'"
  exit
end

puts 'location will default' if !location || location.empty?

vehicles = Freerider.new(location, key).find_vehicles(fuel_threshold)
vehicles.each do |vehicle|
  puts RECORD_DELIMITER
  puts Formatter.format_vehicle(vehicle.to_json)
end
puts SUMMARY_BORDER
# 25 is the current default
notify_suffix = "with a fuel level below #{fuel_threshold || 25} percent"
if vehicles.size > 0
  cars = if vehicles.size > 1
           'cars'
         else
           'car'
         end

  print "#{vehicles.size} #{cars} found #{notify_suffix}"
else
  print "No cars found #{notify_suffix}"
end
puts "\n#{SUMMARY_BORDER}"
